<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>AppFibra - Dashboard Contratos</title>

    <!-- Bootstrap 5 CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <!-- Bootstrap Icons (para usar iconos en sidebar y barra) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <!-- Google Fonts: Roboto (opcional) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* ========== GLOBAL STYLES ========== */
      body {
        font-family: 'Roboto', sans-serif;
        background-color: #f8f9fa;
      }
      a {
        text-decoration: none;
      }
      a:hover {
        text-decoration: none;
      }
      
      /* ========== REACT-STYLE NAVBAR ========== */
      .navbar-react {
        background-color: #20232a;
        padding: 0.5rem 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .navbar-brand-react {
        color: #61dafb !important;
        font-weight: 700;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
      }

      .nav-link-react {
        color: #ffffff !important;
        font-weight: 500;
        padding: 0.5rem 1rem !important;
        transition: all 0.3s ease;
      }

      .nav-link-react:hover,
      .nav-link-react.active {
        color: #61dafb !important;
        background-color: rgba(97, 218, 251, 0.1);
        border-radius: 4px;
      }

      .navbar-toggler-react {
        border-color: rgba(97, 218, 251, 0.1);
      }

      .navbar-toggler-react-icon {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%2897, 218, 251, 0.75%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
      }

      /* ========== SIDEBAR STYLES ========== */
      #sidebar-wrapper {
        min-height: 100vh;
        border-right: 1px solid #dee2e6;
        background-color: #ffffff;
      }
      .sidebar-heading {
        font-size: 1.2rem;
        font-weight: 600;
        padding: 1rem;
      }
      .list-group-item.active {
        background-color: #0d6efd;
        color: #fff;
        border-color: #0d6efd;
      }

      /* ========== PAGE CONTENT WRAPPER ========== */
      #page-content-wrapper {
        width: 100%;
        min-height: 100vh;
      }

      /* ========== TOP NAVBAR ========== */
      .navbar-brand {
        font-weight: bold;
        letter-spacing: 1px;
      }

      /* ========== DASHBOARD SECTION ========== */
      .card-header {
        font-weight: 500;
      }
      #dashboardStatsTable thead th {
	  background-color: #f8f9fa;
	  font-weight: 600;
	  vertical-align: middle;
	}
	
	#dashboardStatsTable tbody tr:hover {
	  background-color: #f1f3f5;
	}
	
	#dashboardStatsTable td.text-end {
	  font-variant-numeric: tabular-nums;
	  font-size: 0.95rem;
	}
	
	#dashboardStatsTable td strong {
	  font-weight: 700;
	  color: #212529;
	}
	
	#dashboardStatsTable td:first-child {
	  font-weight: 500;
	  white-space: nowrap;
	}
	
	#dashboardStatsTable {
	  border-radius: 8px;
	  overflow: hidden;
	}
	      

      /* ========== TABLE OF CONTRACTS ========== */
      #contractsTable {
	  border-collapse: separate;
	  border-spacing: 0;
	  background-color: white;
	  box-shadow: 0 0 0 1px #dee2e6;
	  border-radius: 8px;
	  overflow: hidden;
	}
	
	#contractsTable thead th {
	  position: sticky;
	  top: 0;
	  background: #343a40;
	  color: #ffffff;
	  z-index: 10;
	  font-size: 0.875rem;
	  padding: 0.75rem;
	  text-align: left;
	}
	
	#contractsTable tbody tr:nth-child(even) {
	  background-color: #f8f9fa;
	}
	
	#contractsTable tbody tr:hover {
	  background-color: #e0f0ff;
	  transition: background-color 0.2s ease;
	  cursor: pointer;
	}
	
	#contractsTable td {
	  font-size: 0.875rem;
	  padding: 0.6rem 0.75rem;
	  vertical-align: middle;
	  border-top: 1px solid #dee2e6;
	}
	
	#contractsTable .status-pill {
	  display: inline-block;
	  padding: 0.25em 0.6em;
	  font-size: 0.75rem;
	  font-weight: 500;
	  border-radius: 12px;
	  color: white;
	}
	
	.status-pill.status-ok {
	  background-color: #198754;
	}
	.status-pill.status-warning {
	  background-color: #ffc107;
	  color: #212529;
	}
	.status-pill.status-error {
	  background-color: #dc3545;
	}
	
	.action-buttons {
	  display: flex;
	  gap: 0.25rem;
	}
	
	.action-buttons .btn {
	  font-size: 0.75rem;
	  padding: 0.25rem 0.5rem;
	}

      /* ========== BARS IN STATS TABLE (OPCIONAL) ========== */
      .bar-container {
        background-color: #e9ecef;
        border-radius: 5px;
        height: 10px;
        width: 100%;
        margin-top: 2px;
      }
      .bar {
        height: 100%;
        border-radius: 5px;
        background-color: #0d6efd;
        transition: width 0.4s ease-in-out;
      }

      /* ========== MEDIA QUERIES ========== */
      @media (max-width: 992px) {
        /* Ajustes para pantallas medianas o peque√±as */
        #sidebar-wrapper {
          min-height: auto;
        }
        sidebarMenu .list-group-item.active {
		  background-color: #0d6efd; /* azul bootstrap */
		  color: white;
		  border: none;
		}
		#sidebarMenu .list-group-item.active i {
		  color: white;
		}
      }
    </style>
  </head>

  <body>
  
  <!-- ========== REACT-STYLE NAVBAR ========== -->
    <!-- ‚úÖ Barra superior fija: logo + usuario -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container-fluid">
    <!-- Logo -->
    <a class="navbar-brand fw-bold text-info" href="/">
      <i class="bi bi-fiber_manual-record me-2"></i> AppFibra
    </a>

    <!-- Usuario -->
    <ul class="navbar-nav ms-auto">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle text-light" href="#" role="button" data-bs-toggle="dropdown">
          <i class="bi bi-person-circle me-1"></i> Rabie Samadi
        </a>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="#">Perfil</a></li>
          <li><a class="dropdown-item" href="#">Configuraci√≥n</a></li>
          <li><hr class="dropdown-divider" /></li>
          <li><a class="dropdown-item text-danger" href="#">Cerrar sesi√≥n</a></li>
        </ul>
      </li>
    </ul>
  </div>
</nav>

<!-- ‚úÖ Barra de navegaci√≥n horizontal -->
<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom mt-5">
  <div class="container-fluid">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topMenu">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="topMenu">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link active" href="/home">
            <i class="bi bi-house-door me-1"></i> Inicio
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/dashboard">
            <i class="bi bi-speedometer2 me-1"></i> Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/contracts">
            <i class="bi bi-file-earmark-text me-1"></i> Contratos
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/analytics">
            <i class="bi bi-bar-chart-line me-1"></i> Anal√≠ticas
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/settings">
            <i class="bi bi-gear me-1"></i> Configuraci√≥n
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>
    
	
	<script>
	// ==== SCRIPT PARA ACTIVAR EL BOT√ìN PULSADO EN EL SIDEBAR ====
	document.querySelectorAll('#sidebarMenu a').forEach(link => {
	  link.addEventListener('click', function(e) {
	    // Quitamos 'active' a todos
	    document.querySelectorAll('#sidebarMenu a').forEach(l => l.classList.remove('active'));
	    // A√±adimos 'active' al pulsado
	    this.classList.add('active');
	  });
	});
	</script>
	
	

      <!-- ========== PAGE CONTENT ========== -->
      <div id="page-content-wrapper">
      
        

        <!-- MAIN CONTENT -->
<div class="container-fluid py-3">
  <div class="row g-4">
    <!-- ‚ÜôÔ∏è Estad√≠sticas + B√∫squeda/Resumen   (dos cards apiladas en pantallas md, lado a lado en xl) -->
    <div class="col-12 col-xl-6 d-flex flex-column gap-4">

      <!-- üìä Estad√≠sticas del Dashboard -->
      <div class="card shadow-sm flex-grow-1">
        <div class="card-header bg-transparent border-bottom-0 d-flex justify-content-between align-items-center">
          <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Estad√≠sticas</h6>
          <input id="statsSearchInput"
                 type="text"
                 class="form-control form-control-sm w-auto"
                 placeholder="Filtrar‚Ä¶" />
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table id="dashboardStatsTable" class="table table-striped table-hover table-bordered table-sm align-middle">
			  <thead class="table-light text-center sticky-top" style="z-index: 5;"></thead>
			  <tbody></tbody>
			</table>
			            
          </div>
        </div>
      </div>

      <!-- üîç Buscar + üè† Resumen -->
      <div class="card shadow-sm" id="activationCard">
        <div class="card-header bg-transparent border-bottom-0">
          <h6 class="mb-0"><i class="bi bi-search me-2"></i>B√∫squeda &amp; Detalles de Direcci√≥n</h6>
        </div>

        <div class="card-body">
          <!-- Inputs en l√≠nea -->
          <div class="row g-2 align-items-end mb-3">
            <div class="col-12 col-md">
              <label class="form-label mb-1 small fw-semibold" for="globalHomeIdSearch">Home ID</label>
              <input id="globalHomeIdSearch"
                     type="text"
                     class="form-control form-control-sm"
                     placeholder="Home ID‚Ä¶" />
            </div>
            <div class="col-12 col-md">
              <label class="form-label mb-1 small fw-semibold" for="globalBuildingIdSearch">Building ID</label>
              <div class="input-group input-group-sm">
                <input id="globalBuildingIdSearch"
                       type="text"
                       class="form-control"
                       placeholder="Building ID‚Ä¶" />
                <button class="btn btn-primary" type="button" onclick="runGlobalSearch()">
                  <i class="bi bi-search"></i>
                </button>
                <button class="btn btn-outline-secondary" type="button" onclick="clearGlobalSearch()">
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Detalles -->
          <table class="table table-sm table-bordered mb-0">
            <tbody id="filteredDetails">
              <tr><th>Order Date</th>        <td id="detailOrderDate">-</td></tr>
				<tr><th>Task Status</th>            <td id="detailStatus">-</td></tr>
				<tr><th>HAS</th>               <td id="detailActivated">-</td></tr>
				<tr><th>Anschlussstatus</th>   <td id="detailActivationStatus">-</td></tr>
				<tr><th>Activation Date</th>   <td id="detailActivationDate">-</td></tr>
      
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚û°Ô∏è Anal√≠tica de Contratos  (ocupa el ancho completo debajo en md, 6/12 en xl) -->
    <div class="col-12 col-xl-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-transparent border-bottom-0">
          <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Anal√≠tica de Contratos</h6>
        </div>

        <div class="card-body d-flex flex-column">
          <!-- Selects -->
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="aggregationField1" class="form-label small fw-semibold">Grupo 1</label>
              <select id="aggregationField1" class="form-select form-select-sm">
                <option value="access_location">Access Location</option>
                <option value="subtype">Subtype</option>
                <option value="aufgabenstatus">Aufgabenstatus</option>
                <option value="building_status">Building Status</option>
                <option value="pha">PHA</option>
                <option value="has">HAS</option>
                <option value="building_id">Building ID</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="aggregationField2" class="form-label small fw-semibold">Grupo 2</label>
              <select id="aggregationField2" class="form-select form-select-sm">
                <option value="access_location">Access Location</option>
                <option value="subtype">Subtype</option>
                <option value="aufgabenstatus">Aufgabenstatus</option>
                <option value="building_status">Building Status</option>
                <option value="pha">PHA</option>
                <option value="has">HAS</option>
                <option value="building_id">Building ID</option>
              </select>
            </div>
          </div>

          <!-- Gr√°fico -->
          <div class="flex-grow-1">
            <canvas id="aggregationChart" style="max-height: 420px;"></canvas>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
        
        

          <!-- Secci√≥n de Tabla de Contratos -->
          <div class="card shadow-sm mb-4">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <div class="d-flex align-items-center">
                <span class="me-3">Lista de Contratos / Vistas</span>
                <!-- Selector de vistas -->
                <!-- Nav de vistas -->
			<ul class="nav nav-pills nav-fill me-2" id="viewSelectorNav">
			  <li class="nav-item">
			    <a class="nav-link active" data-view="contracts_list" href="#">Contracts List</a>
			  </li>
			  <li class="nav-item">
			    <a class="nav-link" data-view="planner" href="#">Planner</a>
			  </li>
			  <li class="nav-item">
			    <a class="nav-link" data-view="task_units" href="#">Unit Task</a>
			  </li>
			  <li class="nav-item">
			    <a class="nav-link" data-view="buildings_task" href="#">Buildings Task</a>
			  </li>
			  <li class="nav-item">
			    <a class="nav-link" data-view="buildings_status_extended" href="#">Buildings Status Extended</a>
			  </li>
			  <li class="nav-item">
			    <a class="nav-link" data-view="baulist_highlights" href="#">Baulist Highlights</a>
			  </li>
			  <li class="nav-item">
			    <a class="nav-link" data-view="activations_highlights" href="#">Activations Highlights</a>
			  </li>
			  <li class="nav-item">
                <a class="nav-link" data-view="ar_web" href="#">AR Web</a>
			</ul>
			                
              </div>
              <div class="d-flex align-items-center">
                <button
                  class="btn btn-sm btn-outline-primary me-2"
                  id="btnExportExcel"
                >
                  Exportar Excel
                </button>
                <button
                  class="btn btn-sm btn-outline-danger me-3"
                  id="btnExportPDF"
                >
                  Exportar PDF
                </button>
                <button
                  class="btn btn-sm btn-outline-success"
                  id="btnRefresh"
                >
                  Refrescar
                </button>
              </div>
            </div>
            <div class="card-body p-0 table-responsive">
              <table
                class="table table-hover table-sm align-middle mb-0"
                id="contractsTable"
              >
                <thead id="tableHead"></thead>
                <tbody id="contractsTableBody"></tbody>
              </table>
              <div
                class="d-flex justify-content-between align-items-center p-3"
              >
                <div>
                  <button class="btn btn-secondary btn-sm" id="prevPageBtn">
                    ‚Üê Anterior
                  </button>
                  <button class="btn btn-secondary btn-sm" id="nextPageBtn">
                    Siguiente ‚Üí
                  </button>
                </div>
                <div id="paginationInfo" class="small text-muted"></div>
              </div>
            </div>
          </div>
          <!-- Bot√≥n opcional para scroll horizontal en la tabla de contratos -->
          <div class="text-end mt-2">
            <button
              class="btn btn-outline-secondary btn-sm"
              onclick="scrollTableRight()"
            >
              ‚Üí Ver m√°s columnas
            </button>
          </div>
        </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <script>
      /* ================== TABLE OF CONTRACTS CONFIG ================== */
      const viewColumnsConfig = {
    		  contracts_list: [
    			    { key: "home_id",                      label: "üè† Home ID" },
    			    { key: "building_id",                  label: "üè¢ Building ID" },
    			    { key: "subtype",                      label: "üîß Subtype" },
    			    { key: "access_location",              label: "üìç PoP / Location" },
    			    { key: "aufgabenstatus",               label: "üìÑ Contract Status" },
    			    { key: "order_date",                   label: "üóìÔ∏è Order Date" },
    			    { key: "contract_age_weeks",           label: "üìÜ Age (weeks)" },
    			    { key: "building_status",              label: "üè† Building Status" },
    			    { key: "building_status_updated_at",   label: "‚è±Ô∏è Last Update (Building)" },
    			    { key: "building_action_holder",       label: "üë§ Holder (Building)" },
    			    { key: "building_hausbegehung_status", label: "üö™ Home Visit (Building)" },
    			    { key: "unit_status",                  label: "üèòÔ∏è Unit Status" },
    			    { key: "unit_status_updated_at",       label: "‚è±Ô∏è Last Update (Unit)" },
    			    { key: "unit_action_holder",           label: "üë§ Holder (Unit)" },
    			    { key: "unit_hausbegehung_status",     label: "üö™ Home Visit (Unit)" },
    			    { key: "anschlussstatus",              label: "üîå Anschlussstatus" },
    			    { key: "tiefbaudatum",                 label: "üõ†Ô∏è Civil Work Date" },
    			    { key: "activeoperator_name_from_tri", label: "üì° Operator" },
    			    { key: "outsource_name",               label: "üèóÔ∏è Subcontractor" }
    			  ],
    			  planner: [
    				  { key: "auftragsnummer", label: "Home ID" },
    				  { key: "building_id", label: "üè¢ Building ID" },
    				  { key: "projektname", label: "Projektname" },
    				  { key: "projektcode_intern", label: "Projektcode Intern" },
    				  { key: "anschlussstatus", label: "üîå Anschlussstatus" },
    				  { key: "teilpolygon", label: "Teilpolygon" },
    				  { key: "dp_name", label: "DP Name" },
    				  { key: "kabel_id_from_engineering", label: "Kabel ID from Engineering" },
    				  { key: "tzip", label: "TZIP" },
    				  { key: "strasse", label: "üõ£Ô∏è Stra√üe" },
    				  { key: "hausnummer", label: "üè† Hausnummer" },
    				  { key: "hausnummernzusatz", label: "üè† Hausnummer Zusatz" },
    				  { key: "unit", label: "üî¢ Unit" },
    				  { key: "grundna", label: "GrundNA" },
    				  { key: "zustimmung", label: "Zustimmung" },
    				  { key: "baulist_datum", label: "üìÖ Baulist Datum" },
    				  { key: "civiel_startdatum", label: "üìÖ Civiel Startdatum" },
    				  { key: "tiefbaudatum", label: "üìÖ Tiefbaudatum" },
    				  { key: "civiel_einddatum", label: "üìÖ Civiel Einddatum" },
    				  { key: "plandatum", label: "üìÖ Plandatum" },
    				  { key: "reihe_from_engineering", label: "Reihe from Engineering" },
    				  { key: "schrank_from_engineering", label: "Schrank from Engineering" },
    				  { key: "block_from_engineering", label: "Block from Engineering" },
    				  { key: "odf_catv_position_from_engineering", label: "ODF CATV Position" },
    				  { key: "odf_ip_from_engineering", label: "ODF IP from Engineering" },
    				  { key: "odf_ip_position_from_engineering", label: "ODF IP Position" },
    				  { key: "has_ip_fiber", label: "HAS IP Fiber" },
    				  { key: "has_tv_fiber", label: "HAS TV Fiber" },
    				  { key: "gebaeudetyp", label: "Geb√§udetyp" },
    				  { key: "order_template", label: "üìÑ Order Template" },
    				  { key: "datum_hausbegehung", label: "üìÖ Datum Hausbegehung" },
    				  { key: "status_hausbegehung", label: "üìç Status Hausbegehung" },
    				  { key: "has_aktivierung_geplant", label: "HAS Aktivierung Geplant" },
    				  { key: "kunde_zufrieden_installation", label: "üßë‚Äçüíº Kunde Zufrieden Installation" },
    				  { key: "auftragsnummer_extern", label: "Auftragsnummer Extern" },
    				  { key: "totale_lengte", label: "üìè Totale L√§nge" },
    				  { key: "dp_tiefbau_fertig", label: "üöß DP Tiefbau Fertig" },
    				  { key: "graaflengte_produktion_totaal", label: "üìè Graafl√§nge Produktion Total" },
    				  { key: "nog_te_graven", label: "Nog te Graven" },
    				  { key: "tknr", label: "TKNr" },
    				  { key: "farbe_rohre", label: "üé® Farbe Rohre" },
    				  { key: "datum_hausanschluss", label: "üìÖ Datum Hausanschluss" },
    				  { key: "fertigstellungsdatum_teilstueck", label: "üìÖ Fertigstellungsdatum Teilst√ºck" },
    				  { key: "ready_108", label: "Ready 108" },
    				  { key: "abhaengigkeit", label: "Abh√§ngigkeit" },
    				  { key: "gartenbohrung_durchgefuehrt", label: "ü™õ Gartenbohrung durchgef√ºhrt" },
    				  { key: "hc_hup_standort_hup", label: "üìç HUP Standort" },
    				  { key: "activeoperator_name_from_tri", label: "üì° Operator" },
    				  { key: "bautyp", label: "üèóÔ∏è Bautyp" }
    				]
,
task_units: [
	  { key: "assignment_number", label: "üìÑ Assignment Number" },
	  { key: "building_id", label: "üè¢ Building ID" },
	  { key: "project_number", label: "üìÅ Project Number" },
	  { key: "ap_from_tri", label: "üì° AP (TRI)" },
	  { key: "dp", label: "üìç DP" },
	  { key: "street", label: "üõ£Ô∏è Street" },
	  { key: "zip_code", label: "üìÆ ZIP Code" },
	  { key: "house_number", label: "üè† House Number" },
	  { key: "house_number_addition", label: "‚ûï House No. Addition" },
	  { key: "room", label: "üö™ Room" },
	  { key: "order_template", label: "üìë Order Template" },
	  { key: "status", label: "üìã Status" },
	  { key: "anschlussstatus", label: "üîå Anschlussstatus" },
	  { key: "grundna", label: "‚öôÔ∏è GrundNA" },
	  { key: "garden_bore_done", label: "üåø Garden Bore Done" },
	  { key: "url_faser_am_hauswand", label: "üåê Fiber URL" },
	  { key: "hv_kabellange_einfuhrung_hup", label: "üìè Cable Length to H√úP" },
	  { key: "servicepaket_nicht_verreinbart_instaliert", label: "üì¶ Service Package Not Installed" },
	  { key: "montagetechniker", label: "üë∑ Installer" },
	  { key: "gartenbohrung_fertig", label: "üå± Garden Drilling Done" },
	  { key: "hc_hup_standort_hup_another", label: "üìç HUP Location Alt." },
	  { key: "hv_standort_hup", label: "üìç HUP Location" },
	  { key: "status_1", label: "üìã Status 1" },
	  { key: "number_of_we", label: "üèòÔ∏è Number of Units" },
	  { key: "hc_hup_standort_hup_another_1", label: "üìç HUP Location Alt. 2" },
	  { key: "name_des_hausbeghers", label: "üë§ House Visit Contact" },
	  { key: "anzahl_eingeblasene_hp_adressen", label: "üî¢ HP Blown Addresses" },
	  { key: "spleisse_ap_bereit", label: "üí° Splice AP Ready" },
	  { key: "spleisse_dp_bereit", label: "üîß Splice DP Ready" },
	  { key: "fertigstellungsdatum_teilstuck", label: "üìÖ Completion Date (Segment)" },
	  { key: "hv_date", label: "üìÖ HV Date" },
	  { key: "erklarung_status", label: "üìÑ Explanation Status" },
	  { key: "erklarungsstatus", label: "üìÑ Explanation Substatus" },
	  { key: "aktivation_bemerkung", label: "üìù Activation Notes" },
	  { key: "ready_108", label: "‚úÖ Ready 108" },
	  { key: "subtype_from_tri", label: "üìÇ Subtype (TRI)" },
	  { key: "serviceprovider_from_tri", label: "üè¢ Service Provider Code" },
	  { key: "serviceprovider_name_from_tri", label: "üè¢ Service Provider" },
	  { key: "anzahl_we", label: "üèòÔ∏è Units Count" },
	  { key: "bis_we_anzahl", label: "‚ÜîÔ∏è Units Range" },
	  { key: "name", label: "üë§ Name" },
	  { key: "status_updated_at", label: "‚è±Ô∏è Status Updated" },
	  { key: "action_holder", label: "üë§ Action Holder" },
	  { key: "active_operator", label: "üì° Active Operator" },
	  { key: "tiefbau_date", label: "üöß Civil Work Date" },
	  { key: "place", label: "üìç Place" },
	  { key: "status_hausbegehung", label: "üö™ House Visit Status" },
	  { key: "status_hausbegehung_hv_s_from_house", label: "üö™ Visit HV From House" }
	],


        buildings_task: [
          "building_id", "building_status", "building_action_holder", " "
        ],
        ar_web: [
        	  { key: "home_id", label: "üè† Home ID" },
        	  { key: "building_id", label: "üè¢ Building ID" },
        	  { key: "cable_id", label: "üîå Cable ID" },
        	  { key: "plot", label: "üß≠ Plot" },
        	  { key: "tzip", label: "üìÆ TZIP" },
        	  { key: "number", label: "# House Number" },
        	  { key: "suffix", label: "üî§ Suffix" },
        	  { key: "unit", label: "üèòÔ∏è Unit" },
        	  { key: "street", label: "üõ£Ô∏è Street" },
        	  { key: "city", label: "üèôÔ∏è City" },
        	  { key: "date_last_update", label: "üìÜ Last Update" },
        	  { key: "last_updated_by", label: "üë§ Updated By" },
        	  { key: "start_date_civil_work", label: "üöß Civil Work Start" },
        	  { key: "plan_date_has", label: "üìÖ Plan HAS Date" },
        	  { key: "has_date", label: "üìÖ HAS Date" },
        	  { key: "hp_plandate", label: "üìÖ HP Plan Date" },
        	  { key: "delivery_date_passive", label: "üì¶ Passive Delivery" },
        	  { key: "delivery_status", label: "üìã Delivery Status" },
        	  { key: "reason_nc", label: "‚ùó Reason NC" },
        	  { key: "area_pop", label: "üìç PoP Area" },
        	  { key: "row", label: "üß± Row" },
        	  { key: "frame", label: "üñºÔ∏è Frame" },
        	  { key: "block", label: "üî≤ Block" },
        	  { key: "odf", label: "üîå ODF" },
        	  { key: "odf_position", label: "üìç ODF Pos." },
        	  { key: "odf_status", label: "üìä ODF Status" },
        	  { key: "odf_last_update", label: "üìÜ ODF Updated" },
        	  { key: "connection_id", label: "üîó Conn. ID" },
        	  { key: "odfcatv", label: "üì° CATV ODF" },
        	  { key: "odfcatv_position", label: "üìç CATV Pos." },
        	  { key: "odfcatv_status", label: "üìä CATV Status" },
        	  { key: "odfcatv_last_update", label: "üìÜ CATV Updated" },
        	  { key: "connection_id_catv", label: "üîó CATV Conn. ID" },
        	  { key: "ftu_type", label: "üîß FTU Type" },
        	  { key: "permission_to_build", label: "üìù Permiso Obra" },
        	  { key: "building_type", label: "üè¢ Type Building" },
        	  { key: "type_of_construction", label: "üèóÔ∏è Construction Type" },
        	  { key: "project_code", label: "üßæ Project Code" },
        	  { key: "project_name", label: "üìÅ Project Name" },
        	  { key: "connection_area_number", label: "üìç Conn. Area No." },
        	  { key: "connection_area_name", label: "üìç Conn. Area Name" },
        	  { key: "contractor", label: "üë∑ Contractor" },
        	  { key: "project_construction_type", label: "üèóÔ∏è Project Const. Type" },
        	  { key: "remark", label: "üóíÔ∏è Remark" },
        	  { key: "strand_id", label: "üßµ Strand ID" },
        	  { key: "throughput_dependency", label: "üîÑ Dependency" },
        	  { key: "floor", label: "üè¢ Floor" },
        	  { key: "flat_position", label: "üìê Flat Pos." },
        	  { key: "netbuildtype", label: "üåê Net Build Type" },
        	  { key: "network_type", label: "üåç Network Type" },
        	  { key: "projectstatus", label: "üìä Project Status" }
        	],
        
        	baulist_highlights: [
        		  { key: "home_id", label: "üè† Home ID" },
        		  { key: "building_id", label: "üè¢ Building ID" },
        		  { key: "order_id", label: "üÜî Order ID" },
        		  { key: "order_date", label: "üìÖ Order Date" },
        		  { key: "project_code", label: "üî¢ Project Code" },
        		  { key: "project_name", label: "üìõ Project Name" },
        		  { key: "area_pop", label: "üìç Area PoP" },
        		  { key: "city", label: "üèôÔ∏è City" },
        		  { key: "tzip", label: "üì¨ ZIP" },
        		  { key: "street", label: "üõ£Ô∏è Street" },
        		  { key: "house_number", label: "üè† N¬∫" },
        		  { key: "suffix", label: "üî§ Suffix" },
        		  { key: "unit", label: "üèòÔ∏è Unit" },
        		  { key: "completion_date", label: "‚úÖ Completion Date" },
        		  { key: "connection_date", label: "üîå Connection Date" },
        		  { key: "delivery_status", label: "üì¶ Status" },
        		  { key: "reason_nc", label: "‚ùó Reason NC" },
        		  { key: "provider", label: "üèóÔ∏è Provider" },
        		  { key: "co_id", label: "üÜî CO ID" },
        		  { key: "firstname", label: "üë§ First Name" },
        		  { key: "name", label: "üë§ Last Name" },
        		  { key: "phone", label: "üìû Phone" },
        		  { key: "cell_phone", label: "üì± Cell" },
        		  { key: "mail", label: "‚úâÔ∏è Email" },
        		  { key: "task_status", label: "üìå Task Status" },
        		  { key: "group_name", label: "üß© Group" },
        		  { key: "catv", label: "üì∫ CATV" },
        		  { key: "kid", label: "üßæ KID" },
        		  { key: "hold_message", label: "‚è∏Ô∏è Hold Msg" },
        		  { key: "subtype", label: "üîß Subtype" },
        		  { key: "network_type", label: "üåê Net Type" },
        		  { key: "change_type", label: "üîÅ Change Type" },
        		  { key: "change_week", label: "üìÜ Week (Change)" },
        		  { key: "change_year", label: "üìÜ Year (Change)" },
        		  { key: "order_week", label: "üóìÔ∏è Order Week" },
        		  { key: "order_year", label: "üóìÔ∏è Order Year" }
        		],
          
        		activations_highlights: [
        			  { key: "home_id", label: "üè† Home ID" },
        			  { key: "building_id", label: "üè¢ Building ID" },
        			  { key: "bestellnummer", label: "üÜî Order Number" },
        			  { key: "bestelldatum", label: "üìÖ Order Date" },
        			  { key: "projectcode", label: "üî¢ Project Code" },
        			  { key: "sp_name", label: "üèóÔ∏è Service Provider" },
        			  { key: "access_location", label: "üìç Location / PoP" },
        			  { key: "ort", label: "üèôÔ∏è City" },
        			  { key: "zipcode", label: "üì¨ ZIP Code" },
        			  { key: "stra√üe", label: "üõ£Ô∏è Street" },
        			  { key: "nummer", label: "üè† N¬∫" },
        			  { key: "nrsusatz", label: "üî§ Suffix" },
        			  { key: "weitere_susatz", label: "üèòÔ∏è Unit" },
        			  { key: "lieferdatum", label: "üì¶ Delivery Date" },
        			  { key: "wunschdatum", label: "üóìÔ∏è Desired Date" },
        			  { key: "typ", label: "üîß Type" },
        			  { key: "port_zuweisung", label: "üîå Port Assignment" },
        			  { key: "benutzername", label: "üë§ Username" },
        			  { key: "name", label: "üë§ Name" },
        			  { key: "telefon", label: "üìû Phone" },
        			  { key: "handy", label: "üì± Mobile" },
        			  { key: "email", label: "‚úâÔ∏è Email" },
        			  { key: "aufgabenstatus", label: "üìå Task Status" },
        			  { key: "netzwerktyp", label: "üåê Network Type" },
        			  { key: "catv", label: "üì∫ CATV" },
        			  { key: "kennwort", label: "üîê Password" },
        			  { key: "subtype", label: "üîß Subtype" },
        			  { key: "week", label: "üìÜ Week" },
        			  { key: "year", label: "üìÜ Year" }
        			],


        			buildings_status_extended: [
        				  { key: "home_id", label: "üè† Home ID" },
        				  { key: "building_id", label: "üè¢ Building ID" },
        				  { key: "subtype", label: "üîß Subtype" },
        				  { key: "access_location", label: "üìç PoP / Location" },
        				  { key: "aufgabenstatus", label: "üìå Task Status" },
        				  { key: "weitere_susatz", label: "üèòÔ∏è Unit ID" },
        				  { key: "anschlussstatus_contracts", label: "üîå Anschlussstatus" },
        				  { key: "building_status", label: "üè† Building Status" },
        				  { key: "status_updated_at", label: "‚è±Ô∏è Last Update" },
        				  { key: "action_holder", label: "üë§ Holder" },
        				  { key: "building_hausbegehung_status", label: "üö™ Home Visit (Building)" },
        				  { key: "grundna", label: "üìÑ GrundNA" },
        				  { key: "tiefbaudatum", label: "üõ†Ô∏è Civil Work Date" },
        				  { key: "activeoperator_name_from_tri", label: "üì° Operator" },
        				  { key: "total_units", label: "üî¢ Total Units" },
        				  { key: "planner_contracts", label: "üìë Planner Contracts" },
        				  { key: "pom_contracts", label: "üìë POM Contracts" },
        				  { key: "pha", label: "‚öôÔ∏è PHA" },
        				  { key: "pha_reason", label: "üìù PHA Reason" },
        				  { key: "has_class", label: "üè∑Ô∏è HAS Class" },
        				  { key: "has0_count", label: "0Ô∏è‚É£ HAS0" },
        				  { key: "has1_count", label: "1Ô∏è‚É£ HAS1" },
        				  { key: "has2_count", label: "2Ô∏è‚É£ HAS2" },
        				  { key: "unit_statuses", label: "üèòÔ∏è Unit Statuses" },
        				  { key: "unit_statuses_updated_at", label: "üìÜ Units Updated At" },
        				  { key: "unit_action_holders", label: "üë• Unit Holders" },
        				  { key: "hausbegehung_units_statuses", label: "üö™ Visits (Units)" }
        				]
};


      let currentPage = 0;
      const pageSize = 10;
      let aggregationChart = null;
      
   // ------- Campos de agregaci√≥n permitidos por vista -------
      const aggregationFieldsByView = {
		  contracts_list: ["access_location", "subtype", "aufgabenstatus", "building_status", "unit_status", "anschlussstatus", "building_id","home_id" ,"order_date","unit_hausbegehung_status", "unit_action_holder", "unit_hausbegehung_status", "building_action_holder", "building_hausbegehung_status", "activeoperator_name_from_tri", "outsource_name"],
		  buildings_status_extended: ["access_location", "pha", "has_class", "building_status", "aufgabenstatus"],
		  baulist_highlights: ["order_year","subtype","area_pop","order_date","delivery_status", "task_status", "network_type", "group_name", "order_week"],
		  buildings_task: ["building_id", "building_status", "building_action_holder", "aufgabenstatus"],
		  planner: ["dp_name", "grundna","ready_108","gebaeudetyp", "anschlussstatus", "order_template", "tiefbaudatum", "building_status"],
		  task_units: ["ap_from_tri","status_1","building_id", "project_number", "assignment_number", "dp", "street", "zip_code", "house_number", "house_number_addition", "room", "order_template", "status", "anschlussstatus", "grundna", "garden_bore_done", "url_faser_am_hauswand", "hv_kabellange_einfuhrung_hup", "servicepaket_nicht_verreinbart_instaliert", "montagetechniker", "gartenbohrung_fertig", "hc_hup_standort_hup_another","hv_standort_hup","number_of_we","hc_hup_standort_hup_another_1","name_des_hausbeghers","anzahl_eingeblasene_hp_adressen","spleisse_ap_bereit","spleisse_dp_bereit","fertigstellungsdatum_teilstuck","hv_date","erklarung_status","erklarungsstatus","aktivation_bemerkung","ready_108","subtype_from_tri","serviceprovider_from_tri","serviceprovider_name_from_tri","anzahl_we","bis_we_anzahl"],
		  activations_highlights: [
			  "access_location",
			  "year",
			  "bestellnummer",
			  "bestelldatum",
			  "ort",
			  "zipcode",
			  "aufgabenstatus",
			  "typ",
			  "subtype",
			  "week"
			],
			            ar_web: ["project_name","delivery_status","project_code","home_id","reason_nc","connection_area_number","connection_area_name","odfcatv_position","odfcatv_last_update","odfcatv_status","odfcatv"]

        };


      
      function populateAggregationFields(viewName) {
    	  const columns = viewColumnsConfig[viewName] || [];
    	  const html = columns
    	    .map(col => `<option value="${col.key}">${col.label}</option>`)
    	    .join("");
    	  document.getElementById("aggregationField1").innerHTML = html;
    	  document.getElementById("aggregationField2").innerHTML = html;
    	}


      /* ================== BUILD HEADERS FOR TABLE OF CONTRACTS ================== */
      function buildTableHeaders() {
  const viewName = document.querySelector("#viewSelectorNav .nav-link.active")
                             .dataset.view;
  const columns  = viewColumnsConfig[viewName] || [];
  const thead    = document.getElementById("tableHead");
  thead.innerHTML = "";

  // fila de t√≠tulos
  const trTitles = document.createElement("tr");
  columns.forEach(({ label }) => {
	  const th = document.createElement("th");
	  th.innerHTML = `<div class="d-flex align-items-center gap-1 justify-content-center text-nowrap">
	                    <span class="fw-semibold">${label}</span>
	                  </div>`;
	  trTitles.appendChild(th);
	});

  thead.appendChild(trTitles);

  // fila de filtros
  const trFilters = document.createElement("tr");
  columns.forEach(({ key }) => {
    const th = document.createElement("th");
    const input = document.createElement("input");
    input.type        = "text";
    input.className   = "column-filter form-control form-control-sm";
    input.dataset.column = key;
    input.placeholder = "Filtrar‚Ä¶";
    input.addEventListener("input", () => {
      currentPage = 0;
      fetchContracts();
      updateDashboard();
    });
    th.appendChild(input);
    trFilters.appendChild(th);
  });
  thead.appendChild(trFilters);
}
      
      function updateAggregationFieldOptions() {
    	  const viewName = document.querySelector("#viewSelectorNav .nav-link.active")
    	                            .dataset.view;
    	  const allowed = aggregationFieldsByView[viewName] || [];
    	  const sel1 = document.getElementById("aggregationField1");
    	  const sel2 = document.getElementById("aggregationField2");

    	  // construye opciones bas√°ndote en key + label
    	  const columns = viewColumnsConfig[viewName] || [];
    	  [sel1, sel2].forEach(sel => {
    	    sel.innerHTML = columns
    	      .filter(col => allowed.includes(col.key))
    	      .map(col => `<option value="${col.key}">${col.label}</option>`)
    	      .join("");
    	  });

    	  // valores por defecto
    	  if (allowed.length > 1) {
    	    sel1.value = allowed[0];
    	    sel2.value = allowed[1];
    	  }
    	}


      /* ================== GET FILTERS ================== */
      function getFilters() {
		  const filters = {};
		  document.querySelectorAll(".column-filter").forEach((input) => {
		    const key = input.getAttribute("data-column");
		    let value = input.value.trim();
		
		    if (value) {
		      // Permitir valores m√∫ltiples separados por coma para TODOS los campos
		      value = value
		        .split(",")
		        .map(v => v.trim())
		        .filter(v => v !== "")
		        .join(","); // Enviar como "val1,val2"
		
		      filters[key] = value;
		    }
		  });
		  return filters;
		}


      /* ================== FETCH CONTRACTS ================== */
      function fetchContracts() {
        const filters = getFilters();
        const viewName = document.querySelector("#viewSelectorNav .nav-link.active")
        .getAttribute("data-view");
        const requestBody = {
          draw: 1,
          start: currentPage * pageSize,
          length: pageSize,
          search: { value: "" },
          columns: [],
          filters: { ...filters, view: viewName },
        };

        fetch("/api/contracts/multiview", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(requestBody),
        })
          .then((resp) => resp.json())
          .then((data) => {
            if (data.error) {
              alert("Error: " + data.error);
              return;
            }
            renderTable(data.data);
            renderPagination(data.recordsFiltered, data.recordsTotal);
          })
          .catch((err) => {
            console.error("Error:", err);
            alert("Error al obtener contratos");
          });
      }

      /* ================== RENDER CONTRACTS TABLE ================== */
      function renderTable(rows) {
		  const tbody = document.getElementById("contractsTableBody");
		  const viewName = document.querySelector("#viewSelectorNav .nav-link.active").dataset.view;
		  const columns = viewColumnsConfig[viewName] || [];
		  const dateFields = ["order_date", "bestelldatum", "lieferdatum", "wunschdatum", "tiefbaudatum", "status_updated_at", "unit_status_updated_at","civiel_datum", "civiel_startdatum", "civiel_einddatum", "baulist_datum", "datum_hausbegehung", "datum_hausanschluss", "fertigstellungsdatum_teilstueck", "hv_date", "ready_108", "auftrag_von_tri_datum", "auftrag_von_tri_bis_datum", "auftrag_von_tri_datum_hausbegehung", "auftrag_von_tri_bis_datum_hausbegehung"];
		
		  tbody.innerHTML = "";
		
		  if (!rows || rows.length === 0) {
		    const tr = document.createElement("tr");
		    tr.innerHTML = `<td colspan="${columns.length}" class="text-center py-3">No hay datos</td>`;
		    tbody.appendChild(tr);
		    return;
		  }
		
		  rows.forEach(row => {
		    const tr = document.createElement("tr");
		    columns.forEach(({ key }) => {
		      const td = document.createElement("td");
		
		      if (["anschlussstatus", "anschlussstatus_contracts"].includes(key)) {
		        const status = row[key];
		        const desc = {
		          "0": "Planificada", "91": "No prevista", "105": "DP preparado", "108": "Hasta acera",
		          "102": "Preparado en acera", "109": "Hasta fachada", "103": "Preparado en fachada",
		          "107": "Canalizaci√≥n interna", "101": "Fibra hasta H√úP", "100": "Conectado"
		        }[status] || "Desconocido";
		
		        const colors = {
		          "0": "#adb5bd", "91": "#dee2e6", "105": "#ffcc00", "108": "#ffd166", "102": "#ffe066",
		          "109": "#f8961e", "103": "#f3722c", "107": "#f94144", "101": "#1982c4", "100": "#2a9d8f"
		        };
		        const color = colors[status] || "#ced4da";
		
		        td.innerHTML = `
		          <span class="badge text-dark" style="background:${color};cursor:help" title="${desc}">
		            ${status}
		          </span>`;
		      } else if (dateFields.includes(key)) {
		    	  const raw = row[key];

		    	  // Verifica que sea una cadena v√°lida Y que no sea null/vac√≠a
		    	  if (raw && typeof raw === "string" && raw.trim() !== "") {
		    	    const dateObj = new Date(raw);

		    	    if (!isNaN(dateObj.getTime()) && dateObj.getFullYear() !== 1970) {
		    	      const formatted = dateObj.toISOString().slice(0, 10);
		    	      const weekNumber = getISOWeekNumber(dateObj);
		    	      const tooltip = `${raw} ‚Ä¢ Semana ${weekNumber}`;
		    	      td.innerHTML = `<span title="${tooltip}">${formatted}</span>`;
		    	    } else {
		    	      td.textContent = ""; // Fecha inv√°lida
		    	    }
		    	  } else {
		    	    td.textContent = ""; // nula o vac√≠a
		    	  }
		    	}

 else {
		        td.textContent = row[key] ?? "";
		      }
		
		      tr.appendChild(td);
		    });
		    tbody.appendChild(tr);
		  });
		}

		function getStatusClass(status) {
		  const value = status?.toString().toLowerCase();
		  if (["108", "aktiv"].includes(value)) return "status-ok";
		  if (["109", "pendiente", "in progress"].includes(value)) return "status-warning";
		  return "status-error";
		}
		
		function getISOWeekNumber(date) {
			  const tempDate = new Date(date.getTime());
			  tempDate.setHours(0, 0, 0, 0);
			  // Jueves en la semana actual determina el a√±o de la semana
			  tempDate.setDate(tempDate.getDate() + 3 - (tempDate.getDay() + 6) % 7);
			  const week1 = new Date(tempDate.getFullYear(), 0, 4);
			  return 1 + Math.round(((tempDate - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
			}
		
		function getISOWeekString(date) {
			  const tempDate = new Date(date.getTime());
			  tempDate.setHours(0, 0, 0, 0);
			  tempDate.setDate(tempDate.getDate() + 3 - ((tempDate.getDay() + 6) % 7));
			  const week1 = new Date(tempDate.getFullYear(), 0, 4);
			  const isoYear = tempDate.getFullYear();
			  const weekNumber = 1 + Math.round(((tempDate - week1) / 86400000 - 3 + ((week1.getDay() + 6) % 7)) / 7);
			  return `${isoYear}-W${String(weekNumber).padStart(2, '0')}`;
			}



      /* ================== PAGINATION ================== */
      function renderPagination(recordsFiltered, recordsTotal) {
        let totalPages = Math.ceil(recordsFiltered / pageSize);
        if (totalPages < 1) totalPages = 1;
        document.getElementById(
          "paginationInfo"
        ).textContent = `P√°gina ${currentPage + 1} de ${totalPages}, Total: ${recordsFiltered}/${recordsTotal}`;
        document.getElementById("prevPageBtn").disabled = currentPage === 0;
        document.getElementById("nextPageBtn").disabled =
          currentPage >= totalPages - 1;
      }

      /* ================== DASHBOARD STATS (AGRUPACI√ìN) ================== */
      let dynamicStatsRows = [];
      let currentSubcategories = [];

      function updateDashboard() {
        let filters = getFilters();
        Object.keys(filters).forEach((key) => {
          if (key.toLowerCase() === "source" || key.toLowerCase() === "view") {
            delete filters[key];
          }
        });
        filters.view = document.querySelector("#viewSelectorNav .nav-link.active").getAttribute("data-view");

        const field1 = document.getElementById("aggregationField1").value;
        const field2 = document.getElementById("aggregationField2").value;
        const isHasAggregation = field2 === "has" || field2 === "has_class";
        const url = isHasAggregation
          ? "/api/contracts/aggregation/has-summary"
          : "/api/contracts/aggregation";
        const requestBody = isHasAggregation
          ? { groupField: field1, filters: filters }
          : { field1: field1, field2: field2, filters: filters };

        fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(requestBody),
        })
          .then((resp) => resp.json())
          .then((data) => {
            if (!Array.isArray(data)) {
              console.error("La respuesta de la agregaci√≥n no es un arreglo:", data);
              return;
            }
            let summary = {};
            let subcategories = new Set();
            if (isHasAggregation) {
              data.forEach((item) => {
                const groupKey = item.field || item.field1 || "N/A";
                if (!summary[groupKey]) {
                  summary[groupKey] = { HAS0: 0, HAS1: 0, HAS2: 0 };
                }
                summary[groupKey]["HAS0"] += item.has0 || 0;
                summary[groupKey]["HAS1"] += item.has1 || 0;
                summary[groupKey]["HAS2"] += item.has2 || 0;
                subcategories.add("HAS0");
                subcategories.add("HAS1");
                subcategories.add("HAS2");
              });
            } else {
              data.forEach((item) => {
                const groupKey = item.field1 || "N/A";
                const subKey = item.field2 || "N/A";
                if (!summary[groupKey]) {
                  summary[groupKey] = {};
                }
                summary[groupKey][subKey] =
                  (summary[groupKey][subKey] || 0) + (item.count || 0);
                subcategories.add(subKey);
              });
            }
            subcategories = Array.from(subcategories);
            currentSubcategories = subcategories;
            buildDynamicStatsTable(summary, subcategories);
          })
          .catch((err) =>
            console.error("Error fetching dashboard aggregated data:", err)
          );

        updateAggregationChart();
      }

      function buildDynamicStatsTable(summary, subcategories) {
    	  // Calcula los top 15 subcategor√≠as m√°s comunes (columnas m√°s relevantes)
    	  const topColumns = subcategories
    	    .map(sub => ({
    	      key: sub,
    	      total: Object.values(summary).reduce((sum, row) => sum + (row[sub] || 0), 0)
    	    }))
    	    .sort((a, b) => b.total - a.total)
    	    .slice(0, 5) 
    	    .map(col => col.key);

    	  // Construimos filas
    	  const rows = Object.entries(summary).map(([group, details]) => {
    	    const total = topColumns.reduce((sum, sub) => sum + (details[sub] || 0), 0);
    	    return { group, details, total };
    	  }).sort((a, b) => b.total - a.total);

    	  dynamicStatsRows = rows;
    	  currentSubcategories = topColumns;
    	  displayDynamicStatsRows(rows.slice(0, 5), topColumns);
    	}


      function displayDynamicStatsRows(rows, subcategories) {
    	  const tbody = document.querySelector("#dashboardStatsTable tbody");
    	  if (!tbody) return;
    	  tbody.innerHTML = "";

    	  const thead = document.querySelector("#dashboardStatsTable thead");
    	  const groupFieldLabel = document.querySelector("#aggregationField1 option:checked")?.textContent || "Grupo";
    	  let headerHTML = `<tr><th class="text-start">${groupFieldLabel}</th>`;

    	  subcategories.forEach((sub) => {
    	    headerHTML += `<th class="text-end">${sub}</th>`;
    	  });
    	  headerHTML += `<th class="text-end">Total</th></tr>`;
    	  thead.innerHTML = headerHTML;

    	  rows.forEach((row) => {
    	    let tr = document.createElement("tr");
    	    let cells = `<td class="text-start">${row.group}</td>`;
    	    subcategories.forEach((sub) => {
    	      const value = row.details[sub] || 0;
    	      cells += `<td class="text-end">${value}</td>`;
    	    });
    	    cells += `<td class="text-end"><strong>${row.total}</strong></td>`;
    	    tr.innerHTML = cells;
    	    tbody.appendChild(tr);
    	  });
    	}


      /* ================== SEARCH INPUT FOR STATS TABLE ================== */
      document.addEventListener("DOMContentLoaded", () => {
        const statsSearch = document.getElementById("statsSearchInput");
        if (statsSearch) {
          statsSearch.addEventListener("input", (e) => {
            const query = e.target.value.toLowerCase().trim();
            let filtered = dynamicStatsRows.filter((row) =>
              row.group.toLowerCase().includes(query)
            );
            if (!query) {
              filtered = dynamicStatsRows.slice(0, 5);
            }
            displayDynamicStatsRows(filtered, currentSubcategories);
          });
        }
      });

      function updateAggregationChart() {
    	  const filters = getFilters();
    	  delete filters.source;
    	  delete filters.view;

    	  filters.view = document.querySelector("#viewSelectorNav .nav-link.active")?.getAttribute("data-view");

    	  const field1 = document.getElementById("aggregationField1").value;
    	  const field2 = document.getElementById("aggregationField2").value;
    	  const isHasAggregation = field2 === "has" || field2 === "has_class";

    	  const url = isHasAggregation
    	    ? "/api/contracts/aggregation/has-summary"
    	    : "/api/contracts/aggregation";

    	  const requestBody = isHasAggregation
    	    ? { groupField: field1, filters }
    	    : { field1, field2, filters };

    	  fetch(url, {
    	    method: "POST",
    	    headers: { "Content-Type": "application/json" },
    	    body: JSON.stringify(requestBody),
    	  })
    	    .then((r) => r.json())
    	    .then((data) => {
    	      if (!Array.isArray(data)) {
    	        console.error("Respuesta inesperada:", data);
    	        return;
    	      }

    	      const grouped = {};
    	      data.forEach((item) => {
    	        const key = item.field || item.field1 || "(Sin valor)";
    	        if (!grouped[key]) grouped[key] = {};
    	        if (isHasAggregation) {
    	          grouped[key].HAS0 = item.has0 || 0;
    	          grouped[key].HAS1 = item.has1 || 0;
    	          grouped[key].HAS2 = item.has2 || 0;
    	        } else {
    	          grouped[key][item.field2 || "(Sin valor)"] = item.count;
    	        }
    	      });

    	      const sortedKeys = Object.keys(grouped).sort((a, b) => {
    	        const sum = (o) => Object.values(o).reduce((acc, v) => acc + v, 0);
    	        return sum(grouped[b]) - sum(grouped[a]);
    	      });

    	      const topKeys = sortedKeys.slice(0, 20);
    	      const labels = topKeys.map((l) => l?.trim() || "(Sin valor)");

    	      const series = isHasAggregation
    	        ? ["HAS0", "HAS1", "HAS2"]
    	        : Array.from(new Set(topKeys.flatMap(k => Object.keys(grouped[k]))));

    	      // üé® Generador de colores √∫nicos
    	      function getUniqueColors(count) {
    	        const baseColors = [
    	          "#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd",
    	          "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"
    	        ];
    	        const colors = [];

    	        for (let i = 0; i < count; i++) {
    	          if (i < baseColors.length) {
    	            colors.push(baseColors[i]);
    	          } else {
    	            const hue = (i * 137.5) % 360;
    	            colors.push(`hsl(${hue}, 60%, 55%)`);
    	          }
    	        }

    	        return colors;
    	      }

    	      const colors = getUniqueColors(series.length);

    	      const datasets = series.map((serie, i) => ({
    	        label: serie,
    	        data: labels.map((l) => grouped[l]?.[serie] || 0),
    	        backgroundColor: colors[i],
    	        borderRadius: 4,
    	        barPercentage: 0.8,
    	        categoryPercentage: 0.9
    	      }));

    	      const ctx = document.getElementById("aggregationChart").getContext("2d");
    	      if (aggregationChart) aggregationChart.destroy();
    	      Chart.register(ChartDataLabels);

    	      aggregationChart = new Chart(ctx, {
    	        type: "bar",
    	        data: {
    	          labels: labels,
    	          datasets: datasets,
    	        },
    	        options: {
    	          responsive: true,
    	          maintainAspectRatio: false,
    	          interaction: { mode: "index", intersect: false },
    	          scales: {
    	            x: {
    	              stacked: true,
    	              ticks: {
    	                maxRotation: 45,
    	                callback: (label, idx) => {
    	                  const lbl = labels[idx] || "";
    	                  return lbl.length > 12 ? lbl.slice(0, 12) + "‚Ä¶" : lbl;
    	                },
    	              },
    	              grid: { display: false },
    	            },
    	            y: {
    	              stacked: true,
    	              beginAtZero: true,
    	              title: { display: true, text: "Total" }
    	            },
    	          },
    	          plugins: {
    	            title: {
    	              display: true,
    	              text: `Agregaci√≥n: ${field1} vs ${isHasAggregation ? "HAS Class" : field2}`,
    	              font: { size: 16, weight: "bold" }
    	            },
    	            legend: {
    	              position: "top",
    	              labels: { padding: 12, boxWidth: 14 }
    	            },
    	            tooltip: {
    	              callbacks: {
    	                title: (items) => labels[items[0].dataIndex],
    	                label: (ctx) => {
    	                  const value = ctx.parsed.y;
    	                  const total = datasets.reduce((sum, ds) => sum + ds.data[ctx.dataIndex], 0);
    	                  const pct = total ? ((value / total) * 100).toFixed(1) + "%" : "";
    	                  return ` ${ctx.dataset.label}: ${value} (${pct})`;
    	                }
    	              }
    	            },
    	            datalabels: {
    	              anchor: "center",
    	              align: "center",
    	              clamp: true,
    	              color: "#fff",
    	              font: { size: 10, weight: "bold" },
    	              display: function (ctx) {
    	                const value = ctx.dataset.data[ctx.dataIndex];
    	                const total = ctx.chart.data.datasets.reduce((sum, ds) => sum + ds.data[ctx.dataIndex], 0);
    	                const pct = total ? (value / total) * 100 : 0;
    	                return pct >= 8;
    	              },
    	              formatter: function (value) {
    	                return value > 0 ? `${value}` : "";
    	              }
    	            }
    	          }
    	        }
    	      });
    	    })
    	    .catch((err) => console.error("Error en agregaci√≥n:", err));
    	}


      /* ================== SCROLL TABLE RIGHT ================== */
      function scrollTableRight() {
        const container = document.querySelector(".table-responsive");
        container.scrollLeft += 300;
      }

      /* ================== EVENT HANDLERS ================== */
      document
        .getElementById("btnRefresh")
        .addEventListener("click", () => {
          fetchContracts();
          updateDashboard();
        });
      document
        .getElementById("prevPageBtn")
        .addEventListener("click", () => {
          if (currentPage > 0) {
            currentPage--;
            fetchContracts();
            updateDashboard();
          }
        });
      document
        .getElementById("nextPageBtn")
        .addEventListener("click", () => {
          currentPage++;
          fetchContracts();
          updateDashboard();
        });
      document
        .getElementById("aggregationField1")
        .addEventListener("change", () => {
          updateDashboard();
          updateAggregationChart();
        });
      document
        .getElementById("aggregationField2")
        .addEventListener("change", () => {
          updateDashboard();
          updateAggregationChart();
        });
      document
      .querySelectorAll("#viewSelectorNav .nav-link")
      .forEach(link => link.addEventListener("click", e => {
        e.preventDefault();
        // 1) marcar activo
        document.querySelectorAll("#viewSelectorNav .nav-link")
          .forEach(a => a.classList.remove("active"));
        e.currentTarget.classList.add("active");

        // 2) limpiar p√°gina y repoblar cabeceras y selects
        currentPage = 0;
        const viewName = e.currentTarget.getAttribute("data-view");
        populateAggregationFields(viewName);
        buildTableHeaders();
        updateAggregationFieldOptions();
        fetchContracts();
        updateDashboard();
      }));

      // Carga inicial
      document.addEventListener("DOMContentLoaded", () => {
	  // fija tu vista por defecto‚Ä¶
	  const defaultView = "contracts_list";
	  document.querySelectorAll("#viewSelectorNav .nav-link")
	    .forEach(a => a.classList.remove("active"));
	  document.querySelector(`#viewSelectorNav .nav-link[data-view='${defaultView}']`)
	    .classList.add("active");
	
	  populateAggregationFields(defaultView);
	  buildTableHeaders();
	  updateAggregationFieldOptions();
	  fetchContracts();
	  updateDashboard();
	});


      /* ================== EXPORT TO EXCEL/PDF ================== */
      document
        .getElementById("btnExportExcel")
        .addEventListener("click", () => {
          exportTableToCSV("Contratos.csv");
        });
      document
        .getElementById("btnExportPDF")
        .addEventListener("click", () => {
          exportTableToPDF();
        });

      async function exportTableToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: "l", unit: "pt", format: "a4" });
        doc.setFontSize(12);
        doc.text("Reporte de Contratos", 40, 40);
        const rows = [];
        const table = document.getElementById("contractsTable");
        const tableRows = table.querySelectorAll("tr");
        const headers = [];
        tableRows[0].querySelectorAll("th").forEach((th) =>
          headers.push(th.innerText)
        );
        rows.push(headers);

        for (let i = 2; i < tableRows.length; i++) {
          let rowData = [];
          tableRows[i].querySelectorAll("td").forEach((td) =>
            rowData.push(td.innerText)
          );
          if (rowData.length > 0) {
            rows.push(rowData);
          }
        }

        const cellWidth = 100;
        let currentY = 70;
        rows.forEach((row, idx) => {
          let currentX = 40;
          row.forEach((cell) => {
            doc.text(cell, currentX, currentY, { maxWidth: cellWidth });
            currentX += cellWidth;
          });
          currentY += 16;
          if (currentY > 550) {
            doc.addPage();
            currentY = 40;
          }
        });
        doc.save("Contratos.pdf");
      }

      async function fetchAllFilteredRows() {
    	  const filters = getFilters();
    	   const viewName = document
    	  .querySelector("#viewSelectorNav .nav-link.active")
    	  .getAttribute("data-view");
    	  const requestBody = {
    	    draw: 1, start: 0, length: -1, // -1 means "all" (backend should honor this)
    	    search: { value: "" }, columns: [], filters: { ...filters, view: viewName }
    	  };
    	  const resp = await fetch("/api/contracts/multiview", {
    	    method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(requestBody)
    	  });
    	  const data = await resp.json();
    	  if (data.error) throw new Error(data.error);
    	  return data.data || [];
    	}
      
      const globalSearchMapping = {
    		  home_id: {
    		    contracts_list: "home_id",
    		    planner: "auftragsnummer",
    		    buildings_status_extended: "home_id",
    		    task_units: "assignment_number",
    		    baulist_highlights: "home_id",
    		    activations_highlights: "home_id",
    		    buildings_task: "building_id",
    		    ar_web: "home_id"
    		  },
    		  building_id: {
    		    contracts_list: "building_id",
    		    planner: "building_id",
    		    buildings_status_extended: "building_id",
    		    task_units: "building_id",
    		    baulist_highlights: "building_id",
    		    activations_highlights: "building_id",
    		    buildings_task: "building_id",
    		    ar_web: "building_id"
    		  }
    		};

      
      function runGlobalSearch() {
    	  const homeId = document.getElementById("globalHomeIdSearch").value.trim();
    	  const buildingId = document.getElementById("globalBuildingIdSearch").value.trim();
    	  const viewName = document.querySelector("#viewSelectorNav .nav-link.active").getAttribute("data-view");

    	  const allowedColumns = viewColumnsConfig[viewName] || [];

    	  if (homeId) {
    	    const columnName = (viewName === "contracts_list") ? "home_id"
    	                     : (viewName === "planner") ? "auftragsnummer"
    	                   	 : (viewName === "task_units") ? "assignment_number"
    	                     : "home_id"; // por defecto

    	    document.querySelectorAll(`.column-filter[data-column='${columnName}']`)
    	      .forEach(input => input.value = homeId);
    	  }

    	  if (buildingId && allowedColumns.includes("building_id")) {
    	    document.querySelectorAll(".column-filter[data-column='building_id']")
    	      .forEach(input => input.value = buildingId);
    	  }

    	  fetchContracts();
    	  updateDashboard();
    	  fetchHomeDetails(homeId, buildingId);
    	}


    	function clearGlobalSearch() {
    	  document.getElementById("globalHomeIdSearch").value = "";
    	  document.getElementById("globalBuildingIdSearch").value = "";

    	  document.querySelectorAll(".column-filter").forEach(input => input.value = "");

    	  currentPage = 0;
    	  fetchContracts();
    	  updateDashboard();
    	  fetchHomeDetails(homeId, buildingId);
    	}
    	
    	function getActiveViewName() {
    		  return document.querySelector("#viewSelectorNav .nav-link.active")?.dataset.view || "contracts_list";
    		}

    	function getBuildingIdFromHome(homeId) {
    		  if (!homeId) return "";
    		  // corta desde el pen√∫ltimo "_" para atr√°s
    		  const idx = homeId.lastIndexOf("__");
    		  return idx > -1 ? homeId.slice(0, idx + 1) : homeId;
    		}

    	
    	async function fetchHomeDetails(homeId, buildingIdInput) {
    		  /* elementos del DOM */
    		  const elOrder   = document.getElementById("detailOrderDate");
    		  const elStatus  = document.getElementById("detailStatus");
    		  const elHas     = document.getElementById("detailActivated");
    		  const elAnsch   = document.getElementById("detailActivationStatus");
    		  const elactivdate = document.getElementById("detailActivationDate");
    		  
    		  if (!elOrder || !elStatus || !elHas || !elAnsch || !elactivdate) {
    			  console.warn("‚ùå Elemento(s) del DOM no encontrados");
    			  return;
    			}

    		  elOrder.textContent = elStatus.textContent = elHas.textContent = "-";
    		  elAnsch.textContent = "-";

    		  /*  ‚ûú buildingId definitivo  */
    		  const buildingId = buildingIdInput || getBuildingIdFromHome(homeId);

    		  /* --- 1. ORDER DATE  (baulist_highlights) -------------------- */
    		  if (homeId) {
    		    const row = await fetchOne({ home_id: homeId }, "baulist_highlights");
    		    if (row?.order_date) elOrder.textContent = row.order_date.slice(0, 10);
    		  }

    		  /* --- 2. STATUS  (contracts_list) --------------------------- */
    		  if (homeId) {
    		    const row = await fetchOne({ home_id: homeId }, "contracts_list");
    		    // usa cualquier alias que exista
    		    const status = row?.contract_status || row?.task_status || row?.aufgabenstatus;
    		    if (status) elStatus.textContent = status;
    		  }

    		  /* --- 3. HAS  (buildings_status_extended) ------------------- */
    		  if (buildingId) {
    		    const row = await fetchOne({ building_id: buildingId }, "buildings_status_extended");
    		    if (row?.has_class) elHas.textContent = row.has_class;
    		  }

    		  /* --- 4. ANSCHLUSSSTATUS  (planner) ------------------------- */
    		  if (buildingId) {
    		    const row = await fetchOne({ building_id: buildingId }, "planner");
    		    if (row?.anschlussstatus != null) elAnsch.innerHTML = renderStatusBadge(row.anschlussstatus);
    		  }
    		  /* --- 5. ACTIVATION DATE  (activations_highlights) --------- */
    		  if (homeId) {
    			  const rows = await fetchAll({ home_id: homeId }, "activations_highlights");

    			  const completed = rows.find(r => r.aufgabenstatus?.trim().toUpperCase() === "COMPLETED");

    			  if (completed?.year && completed?.week) {
    				  console.log("‚úîÔ∏è completed row:", completed);

    			    elactivdate.textContent = `${completed.year}-${String(completed.week).padStart(2, '0')}`;
    			  } else {
    			    elactivdate.textContent = "Pending";
    			  }
    		  }
    		}

    		/* Funci√≥n auxiliar gen√©rica: trae 1 fila */
    		async function fetchOne(filterObj, view) {
    		  const body = {
    		    draw: 1, start: 0, length: 1,
    		    search: { value: "" }, columns: [],
    		    filters: { ...filterObj, view }
    		  };
    		  const resp = await fetch("/api/contracts/multiview", {
    		    method: "POST",
    		    headers: { "Content-Type": "application/json" },
    		    body: JSON.stringify(body)
    		  });
    		  const data = await resp.json();
    		  return data?.data?.[0];
    		}
    		
    		async function fetchAll(filterObj, view) {
    			  const body = {
    			    draw: 1, start: 0, length: -1, // -1 para traer todos
    			    search: { value: "" },
    			    columns: [],
    			    filters: { ...filterObj, view }
    			  };
    			  const resp = await fetch("/api/contracts/multiview", {
    			    method: "POST",
    			    headers: { "Content-Type": "application/json" },
    			    body: JSON.stringify(body)
    			  });
    			  const data = await resp.json();
    			  return data?.data || [];
    			}



    	function renderStatusBadge(status) {
    		  const desc = {
    		    "0": "Planificada", "91": "No prevista", "105": "DP preparado", "108": "Hasta acera",
    		    "102": "Preparado en acera", "109": "Hasta fachada", "103": "Preparado en fachada",
    		    "107": "Canalizaci√≥n interna", "101": "Fibra hasta H√úP", "100": "Conectado","99": "Eliminado",
    		  }[status] || "Desconocido";

    		  const colors = {
    		    "0": "#adb5bd", "91": "#dee2e6", "105": "#ffcc00", "108": "#ffd166",
    		    "102": "#ffe066", "109": "#f8961e", "103": "#f3722c", "107": "#f94144",
    		    "101": "#1982c4", "100": "#2a9d8f","99": "#6c757d"
    		  };
    		  const color = colors[status] || "#ced4da";

    		  return `
    		    <span class="badge text-dark" style="background:${color};cursor:help" title="${desc}">
    		      ${status}
    		    </span>
    		  `;
    		}




    	/* ---- Export to EXCEL ---- */
    	document.getElementById("btnExportExcel").addEventListener("click", async () => {
    	  try {
    	    const rows = await fetchAllFilteredRows();
    	    if (!rows.length) return alert("No hay datos para exportar");
    	    const viewName = document.querySelector("#viewSelectorNav .nav-link.active")
    	    .getAttribute("data-view");
    	    const columns = viewColumnsConfig[viewName];
    	    const csv = [columns.join(",")].concat(rows.map(r => columns.map(c => ("" + (r[c] ?? "")).replace(/[\n\r]+/g, " ")).join(","))).join("\n");
    	    const blob = new Blob([csv], { type: "text/csv" });
    	    const url = URL.createObjectURL(blob);
    	    const a = document.createElement("a");
    	    a.href = url;
    	    a.download = "Contratos.csv";
    	    a.click();
    	    URL.revokeObjectURL(url);
    	  } catch (err) {
    	    console.error(err);
    	    alert("No se pudo exportar a CSV");
    	  }
    	});
    </script>
  </body>
</html>
